parameters:
- name: org
  type: string
- name: project
  type: string
- name: pipelineId
  type: number
- name: commitSha
  type: string
  default: $(Build.SourceVersion)
- name: timeoutMinutes
  type: number
  default: 15

steps:
- task: PowerShell@2
  displayName: 'Ensure dependent pipeline has run'
  inputs:
    targetType: inline
    script: |
      $org = "${{ parameters.org }}"
      $project = "${{ parameters.project }}"
      $pipelineId = "${{ parameters.pipelineId }}"
      $commitSha = "${{ parameters.commitSha }}"
      $timeoutMinutes = [int]"${{ parameters.timeoutMinutes }}"

      $pat = "$(System.AccessToken)"
      $headers = @{ Authorization = "Bearer $pat" }

      Write-Host "Args: org=$org, project=$project, pipelineId=$pipelineId, commitSha=$commitSha, timeoutMinutes=$timeoutMinutes"

      if ([string]::IsNullOrWhiteSpace($org) -or [string]::IsNullOrWhiteSpace($project)) {
        Write-Error "‚ùå Missing org or project."
        exit 1
      }

      # Build URL safely
      $baseUrl = "https://dev.azure.com/$org/$project/_apis/build/builds"
      $queryUrl = "$baseUrl`?definitions=$pipelineId&sourceVersion=$commitSha&api-version=7.1-preview.7"

      Write-Host "üîç Checking pipeline $pipelineId for commit $commitSha..."
      Write-Host "Using URL: $queryUrl"
      Write-Host "baseUrl: $baseUrl"

      $response = Invoke-RestMethod -Uri $queryUrl -Headers $headers
      $run = $response.value | Sort-Object id -Descending | Select-Object -First 1

      Write-Host "Found run: $($run | ConvertTo-Json -Depth 5)"

      if ($null -ne $run -and $run.sourceVersion -eq $commitSha) {
        if ($run.result -eq "succeeded") {
          Write-Host "‚úÖ Pipeline already ran successfully. Continuing..."
          return
        }
        elseif ($run.status -eq "inProgress") {
          Write-Host "‚è≥ Pipeline is already running. Waiting for completion..."
          $runId = $run.id
        }
        elseif ($run.result -eq "failed" -or $run.result -eq "canceled") {
          Write-Error "‚ùå Pipeline run $($run.id) failed or was canceled."
          exit 1
        }
        else {
          Write-Host "‚ö†Ô∏è Pipeline ran but did not succeed. Treating as no run."
          $run = $null
        }
      }
      else{
        Write-Host "üöÄ No matching run found for commit $commitSha. Treating as no run."
        $run = $null
      }

      if ($null -eq $run) {
        Write-Host "üöÄ No run found. Triggering pipeline $pipelineId..."
        $triggerUrl = "https://dev.azure.com/$org/$project/_apis/pipelines/$pipelineId/runs?api-version=7.1-preview.1"
        $body = @{ resources = @{ repositories = @{ self = @{ refName = "$(Build.SourceBranch)" } } } } | ConvertTo-Json -Depth 10
        $triggerResponse = Invoke-RestMethod -Uri $triggerUrl -Headers $headers -Method Post -Body $body -ContentType "application/json"
        $runId = $triggerResponse.id
        Write-Host "üìå Triggered pipeline run $runId"
      }

      # Poll until completion or timeout
      $deadline = (Get-Date).AddMinutes($timeoutMinutes)
      do {
        Start-Sleep -Seconds 30
        $statusResponse = Invoke-RestMethod -Uri "$baseUrl/$runId`?api-version=7.1-preview.7" -Headers $headers
        Write-Host "‚è≥ Status: $($statusResponse.status)..."
        if ($statusResponse.status -eq "completed") {
          if ($statusResponse.result -eq "succeeded") {
            Write-Host "‚úÖ Pipeline $pipelineId completed successfully."
            return
          }
          else {
            Write-Error "‚ùå Pipeline $pipelineId finished with result: $($statusResponse.result)."
            exit 1
          }
        }
      } while ((Get-Date) -lt $deadline)

      Write-Error "‚è∞ Timeout: Pipeline $pipelineId did not finish within $timeoutMinutes minutes."
      exit 1
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
