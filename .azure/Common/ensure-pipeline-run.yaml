parameters:
- name: org
  type: string
- name: project
  type: string
- name: pipelineId
  type: number
- name: commitSha
  type: string
  default: $(Build.SourceVersion)
- name: timeoutMinutes
  type: number
  default: 15

steps:
- powershell: |
    $org = $args[0]
    $project = $args[1]
    $pipelineId = [int]$args[2]
    $commitSha = $args[3]
    $timeoutMinutes = [int]$args[4]

    $pat = "$(System.AccessToken)"
    $headers = @{ Authorization = "Bearer $pat" }

    if ([string]::IsNullOrWhiteSpace($org) -or [string]::IsNullOrWhiteSpace($project)) {
      Write-Error "âŒ Missing org or project. Got org='$org', project='$project', pipelineId='$pipelineId', commitSha='$commitSha', timeoutMinutes='$timeoutMinutes'
      exit 1
    }

    # Build URL safely
    $baseUrl = "https://dev.azure.com/$org/$project/_apis/build/builds"
    $queryUrl = "$baseUrl?definitions=$pipelineId&sourceVersion=$commitSha&api-version=7.1-preview.7"

    if (-not $queryUrl.StartsWith("https://")) {
      Write-Error "âŒ Invalid URL built: $queryUrl"
      exit 1
    }

    Write-Host "ğŸ” Checking pipeline $pipelineId for commit $commitSha..."
    Write-Host "Using URL: $queryUrl"

    $response = Invoke-RestMethod -Uri $queryUrl -Headers $headers
    $run = $response.value | Sort-Object finishTime -Descending | Select-Object -First 1

    if ($null -ne $run) {
      if ($run.result -eq "succeeded") {
        Write-Host "âœ… Pipeline already ran successfully. Continuing..."
        return
      }
      elseif ($run.status -eq "inProgress") {
        Write-Host "â³ Pipeline is already running. Waiting for completion..."
        $runId = $run.id
      }
      elseif ($run.result -eq "failed" -or $run.result -eq "canceled") {
        Write-Error "âŒ Pipeline run $($run.id) failed or was canceled. Not triggering a new run."
        exit 1
      }
      else {
        Write-Host "âš ï¸ Pipeline ran but did not succeed. Treating as no run."
        $run = $null
      }
    }

    if ($null -eq $run) {
      Write-Host "ğŸš€ No run found. Triggering pipeline $pipelineId..."
      $triggerUrl = "https://dev.azure.com/$org/$project/_apis/pipelines/$pipelineId/runs?api-version=7.1-preview.1"
      $body = @{ resources = @{ repositories = @{ self = @{ refName = "$(Build.SourceBranch)" } } } } | ConvertTo-Json -Depth 10
      $triggerResponse = Invoke-RestMethod -Uri $triggerUrl -Headers $headers -Method Post -Body $body -ContentType "application/json"
      $runId = $triggerResponse.id
      Write-Host "ğŸ“Œ Triggered pipeline run $runId"
    }

    # Poll until completion or timeout
    $deadline = (Get-Date).AddMinutes($timeoutMinutes)
    do {
      Start-Sleep -Seconds 30
      $statusResponse = Invoke-RestMethod -Uri "$baseUrl/$runId?api-version=7.1-preview.7" -Headers $headers
      Write-Host "â³ Status: $($statusResponse.status)..."
      if ($statusResponse.status -eq "completed") {
        if ($statusResponse.result -eq "succeeded") {
          Write-Host "âœ… Pipeline $pipelineId completed successfully."
          return
        }
        else {
          Write-Error "âŒ Pipeline $pipelineId finished with result: $($statusResponse.result)."
          exit 1
        }
      }
    } while ((Get-Date) -lt $deadline)

    Write-Error "â° Timeout: Pipeline $pipelineId did not finish within $timeoutMinutes minutes."
    exit 1
  displayName: 'Ensure dependent pipeline has run'
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    arguments: >
      ${{ parameters.org }}
      ${{ parameters.project }}
      ${{ parameters.pipelineId }}
      ${{ parameters.commitSha }}
      ${{ parameters.timeoutMinutes }}
