parameters:
  - name: org
    type: string
  - name: project
    type: string
  - name: pipelineId
    type: number
  - name: commitSha
    type: string
    default: $(Build.SourceVersion)
  - name: timeoutMinutes
    type: number
    default: 15

steps:
- powershell: |
    $org = "${{ parameters.org }}"
    $project = "${{ parameters.project }}"
    $pipelineId = ${{ parameters.pipelineId }}
    $commitSha = "${{ parameters.commitSha }}"
    $timeoutMinutes = ${{ parameters.timeoutMinutes }}
    $pat = "$(System.AccessToken)"

    $headers = @{ Authorization = "Bearer $pat" }

    $baseUrl = "https://dev.azure.com/$org/$project/_apis/build/builds"
    $queryUrl = "$baseUrl?definitions=$pipelineId&sourceVersion=$commitSha&api-version=7.1-preview.7"

    Write-Host "üîç Checking pipeline $pipelineId for commit $commitSha..."

    $response = Invoke-RestMethod -Uri $queryUrl -Headers $headers

    $run = $response.value | Sort-Object finishTime -Descending | Select-Object -First 1

    if ($null -ne $run) {
      if ($run.result -eq "succeeded") {
        Write-Host "‚úÖ Pipeline already ran successfully. Continuing..."
        return
      }
      elseif ($run.status -eq "inProgress") {
        Write-Host "‚è≥ Pipeline is already running. Waiting for completion..."
      }
      else {
        Write-Host "‚ö†Ô∏è Pipeline ran but did not succeed. Retrying..."
        $run = $null
      }
    }

    if ($null -eq $run) {
      Write-Host "üöÄ No run found. Triggering pipeline $pipelineId..."
      $triggerUrl = "https://dev.azure.com/$org/$project/_apis/pipelines/$pipelineId/runs?api-version=7.1-preview.1"
      $body = @{ resources = @{ repositories = @{ self = @{ refName = "$(Build.SourceBranch)" } } } } | ConvertTo-Json -Depth 10
      $triggerResponse = Invoke-RestMethod -Uri $triggerUrl -Headers $headers -Method Post -Body $body -ContentType "application/json"
      $runId = $triggerResponse.id
      Write-Host "üìå Triggered pipeline run $runId"
    }
    else {
      $runId = $run.id
      Write-Host "üìå Monitoring existing pipeline run $runId"
    }

    # Poll until completion or timeout
    $deadline = (Get-Date).AddMinutes($timeoutMinutes)
    do {
      Start-Sleep -Seconds 30
      $statusResponse = Invoke-RestMethod -Uri "$baseUrl/$runId?api-version=7.1-preview.7" -Headers $headers
      Write-Host "‚è≥ Status: $($statusResponse.status)..."
      if ($statusResponse.status -eq "completed") {
        if ($statusResponse.result -eq "succeeded") {
          Write-Host "‚úÖ Pipeline $pipelineId completed successfully."
          return
        }
        else {
          Write-Error "‚ùå Pipeline $pipelineId failed."
          exit 1
        }
      }
    } while ((Get-Date) -lt $deadline)

    Write-Error "‚è∞ Timeout: Pipeline $pipelineId did not finish within $timeoutMinutes minutes."
    exit 1
  displayName: 'Ensure dependent pipeline has run'
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
