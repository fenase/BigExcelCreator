name: 'BigExcelCreator-sonar'

trigger:
  branches:
    exclude:
      - 'azure-pipelines'
    include:
      - '*'

pool:
  vmImage: 'windows-latest'

variables:
  solution: '**/*.sln'
  mainProject: 'BigExcelCreator/BigExcelCreator.csproj'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
- stage: PrepareAndBuild
  displayName: 'Prepare Environment and Build Solution'
  jobs:
  - job: PrepareAndBuildJob
    steps:
    - checkout: self
      fetchDepth: 0
      clean: true
      fetchTags: true
      displayName: 'Git Checkout'
      enabled: true
      retryCountOnTaskFailure: 2

    - template: Common/InstallEnvironment.yaml

    - task: SonarCloudPrepare@3
      inputs:
        SonarCloud: 'sonar bigexcel'
        organization: 'fenase-1'
        scannerMode: 'dotnet'
        projectKey: 'fenase_BigExcelCreator'
        projectVersion: '3.0'
        extraProperties: |
          # Additional properties that will be passed to the scanner, 
          # Put one key=value per line, example:
          # sonar.exclusions=**/*.bin
          sonar.coverage.exclusions=**/Exceptions/**/*.*, Example/**/*.*

    - template: Common/build.yaml

    # Publish build outputs so later stages can consume them
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Build Artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'
        publishLocation: 'pipeline'

- stage: Test
  displayName: 'Run Tests'
  dependsOn: PrepareAndBuild
  jobs:
  - job: TestJob
    steps:
    # Download the build artifacts from the previous stage
    - task: DownloadPipelineArtifact@2
      displayName: 'Download Build Artifacts'
      inputs:
        artifactName: 'drop'
        targetPath: '$(Pipeline.Workspace)/drop'

    # Run tests against the downloaded binaries
    - task: VSTest@3
      displayName: 'Run Unit Tests'
      inputs:
        testSelector: 'testAssemblies'
        testAssemblyVer2: |
          **\bin\**\*.test.dll
        searchFolder: '$(Pipeline.Workspace)/drop'
        codeCoverageEnabled: true
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'
        diagnosticsEnabled: true

- stage: Analyze
  displayName: 'SonarCloud Analysis'
  dependsOn: Test
  jobs:
  - job: AnalyzeJob
    steps:
    - task: SonarCloudAnalyze@3
      inputs:
        jdkversion: 'JAVA_HOME_21_X64'

- stage: Publish
  displayName: 'Publish Results'
  dependsOn: Analyze
  jobs:
  - job: PublishJob
    steps:
    - task: SonarCloudPublish@3
      inputs:
        pollingTimeoutSec: '300'

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Pipeline.Workspace)'
        publishLocation: 'pipeline'
